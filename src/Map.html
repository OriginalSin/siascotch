<div class="map"></div>
<div class="header">
  <div class="title">
	<input class="zipcode" type="text" placeholder="Enter your City or Zip Code" size="25">
	<input type="submit" value="SUBMIT" class="sButton" on:click="search(this)">
  </div>
  <div class="mode-controls">
	<span class="filterTitle">Filter by</span>
	<a href="#ALL" class="menu current ALL" on:click="set({filter: ''})">ALL</a>  
	<a href="#STORE" class="menu STORE" on:click="set({filter: 'STORE'})">STORES</a>
	<a href="#DRINK" class="menu DRINK" on:click="set({filter: 'DRINK'})">BARS</a>
  </div>
</div>
<div class="viewItemsCountCont">Visible items: <span class="viewItemsCount">0</span></div>
<div class="viewItems">
	{#each layers as it}
	<ListItem item={it} />
	{/each}
</div>

<script>
	import ListItem from './ListItem.html';

	const serverBase = window.serverBase || '//maps.kosmosnimki.ru/';
//<span class="clasters"><input type="checkbox" checked={clasters ? true : false} class="" on:change="set({clasters: this.checked})" /> - clustering</span>
	export default {
		data() {
			return {
				clasters: false,
				layers: {},
				filter: ''
			}
		},
		methods: {
			createMap(it) {
				let {clasters} = this.get();
					it = it || {};
				let app = it.app || {},
					gmxMap = app.gmxMap || {},
					state = it.state || {},
					calendar = state.calendar || {},
					mapID = gmxMap.mapID || '946GH',
					apiKey = gmxMap.apiKey,
					pos = state.map ? state.map.position : {},
					siaJSON = (location.hostname !== '127.0.0.1' && location.pathname.indexOf('/public/') === -1 ? './public/' : '') + 'data/sia6.json';
				
				fetch(siaJSON).then(function(response) {
						return response.json();
					}).then(function(json) {
						if(app.theme) {
							document.body.classList.add(app.theme);
						}
						if(L.leafletMap) {
							L.leafletMap.remove();
						}

						let node = document.getElementsByClassName('map')[0];
						let map = L.leafletMap = new L.Map(node, {
							srs: 3857,
							layers: [L.tileLayer('https://tilessputnik.ru/{z}/{x}/{y}.png', {
								maxZoom: 17
								// ,
								// attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>'
							})],
							attributionControl: false,
							center: new L.LatLng(pos.y || 33.17434155100208, pos.x || -98.0419921875),
							zoom: pos.z || 4
						}).on('moveend', this.setFilter.bind(this));

						let featureCollection = {
								type: 'FeatureCollection', 
								features: json.map(function(it, i) {
									return {
										type: 'Feature', id: i + 1,
										properties: it,
										geometry: { type: 'Point', coordinates: [it.Lng, it.Lat ] }
								}})
							},
							markers = L.markerClusterGroup({
								showCoverageOnHover: false,
								disableClusteringAtZoom: clasters ? 16 : 0
							});

						let geoJsonLayer = this.geoJsonLayer = L.geoJson(featureCollection, {
							pointToLayer: (geoJsonPoint, latlng) => {
								return L.marker(latlng, { icon: L.divIcon({
									iconSize: [26, 26],
									html: geoJsonPoint.id || '21',
									className: 'sia-icon'
								}) });
							},
							onEachFeature: (feature, layer) => {
								let props = feature.properties,
									img = props.Image ? '<img src="' + props.Image + '" />' : '',
									html = img +
										'<br><strong>' + props.Name + '</strong>\
										<br>' + props.Address + '\
										<br>' + props.Zipcode + '\
										<br>' + props['Phone Number'] + '\
										<a href="' + props.Website + '">WEBSITE</a>';
								// layer.bindPopup(html); //, {autoClose: false, closeOnClick: false, keepInView: true});
								layer.on('click', () => {
									L.popup()
										.setLatLng(layer.getLatLng())
										.setContent(html)
										.openOn(map);
								});
							}
						});

						markers.addLayer(geoJsonLayer);
						document.getElementsByClassName('viewItemsCount')[0].innerHTML = featureCollection.features.length;

						map.addLayer(markers);
						this.markers = markers;
						this.setFilter();
						L.leafletMap.locate({setView: true});
					}.bind(this));
			},
			moveend() {
				console.log('moveend', this);
			},
			closeToMe() {
				L.leafletMap.locate({setView: true});
			},
			search(node) {
				console.log('search', node);
				let flayers = this.geoJsonLayer.getLayers(),
					val = node.previousElementSibling.value.trim().toUpperCase(),
					fname = val.match(/[^\d]/) ? 'Address' : 'Zipcode';
				for (let i = 0, len = flayers.length; i < len; i++) {
					let it = flayers[i],
						pv = String(it.feature.properties[fname]).toUpperCase();
					if (pv.indexOf(val) !== -1) {
						L.leafletMap.setView(it.getLatLng(), 17);
						it.openPopup();
						return;
					}
				}
			},
			setFilter() {
				if (this.geoJsonLayer) {
					let {filter} = this.get();
					let flayers = this.geoJsonLayer.getLayers(),
						bbox = L.leafletMap.getBounds(),
						layers = [];
					flayers.forEach(function(it) {
						let feature = it.feature,
							props = feature.properties,
							flag = bbox.contains(it.getLatLng());

						if (filter && props.Category !== filter) { flag = false; }
						if (flag) {
							layers.push(it);
						}
					});
					document.getElementsByClassName('viewItemsCount')[0].innerHTML = layers.length;
					this.markers.clearLayers();
					this.markers.addLayers(layers);
					let node = document.getElementsByClassName('mode-controls')[0];
					node.getElementsByClassName('STORE')[0].classList[filter === 'STORE' ? 'add' : 'remove']('current');
					node.getElementsByClassName('DRINK')[0].classList[filter === 'DRINK' ? 'add' : 'remove']('current');
					node.getElementsByClassName('ALL')[0].classList[filter === '' ? 'add' : 'remove']('current');
					this.set({layers: layers});
				}
			}
		},

		components: {
			ListItem
		},

		onstate({ changed, current, previous }) {
			/* console.log('map onstate', changed, current, previous); */
			if (changed.menu && current.menu === 'retailers') {
				this.createMap(current.permalink);
			}
			if (changed.filter) {
				this.setFilter(current.filter);
			}
			if (changed.clasters && this.markers) {
				this.markers.options.disableClusteringAtZoom = current.clasters ? 16 : 0;
				this.markers.clearLayers();
				this.markers.addLayers(this.geoJsonLayer.getLayers());
			}
		}
	}
</script>

<style>
.map {
    position: relative;
    height: 484px;
	margin: 0 auto;
}
.title {
	float: left;
}
.mode-controls, .clasters {
	float: left;
	height: 31px;
	margin-left: 46px;
	top: 3px;
    position: relative;
}
.viewItemsCountCont {
    margin-top: 30px;
    color: #8a8a8a;
	display: none;
}
.header, .viewItemsCountCont, .viewItems, .map, #site-info-text {
	max-width: 932px;
}
.header, .viewItemsCountCont, .viewItems {
    padding: 10px;
	clear: both;
    margin: 0 auto;
	font-weight: bold;
	text-transform: uppercase;
}

.mode-controls * {
    height: 26px;
	float: left;
    padding: 4px 8px;
}
.mode-controls .filterTitle {
    color: #ef9404;
}
.mode-controls .current {
    position: relative;
    background-color: #ed9605;
    color: black;
}

.mode-controls a {
    color: black;
}
/*
.mode-controls a.current:after {
    position: absolute;
    display: block;
    content: "";
    border-color: #ed9605 transparent transparent transparent;
    border-style: solid;
    border-width: 5px;
    height: 0;
    width: 0;
    position: absolute;
    bottom: -10px;
    left: 37%;
}
*/
.title input {
    font-size: 16px;
	padding: 4px;
}
.title input.sButton {
    background-color: #ed9605;
    border: 0;
    font-family: TradeGothicLTStdBoldCondensed;
    font-weight: bold;
    text-rendering: optimizeLegibility;
    text-transform: uppercase;
    text-align: center;
    color: black;
    height: 31px;
    cursor: pointer;
}

@media only screen and (max-width: 480px) {
	.mode-controls {
		padding-top: 6px;
	}
}

</style>
